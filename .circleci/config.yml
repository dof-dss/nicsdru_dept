version: 2.1

setup: true

orbs:
  continuation: circleci/continuation@0.4.0

workflows:
  setup:
    jobs:
      - fetch-and-continue

jobs:
  fetch-and-continue:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Download shared config
          command: |
            wget \
              --header="Cache-Control: no-cache" \
              --header="Pragma: no-cache" \
              "https://raw.githubusercontent.com/dof-dss/webdev-ci/main/shared-config.yml?nocache=$(date +%s)" \
              -O shared-config.yml

      - run:
          name: Combine shared jobs and local workflows
          command: |
            # Remove the 'version: 2.1' from workflows config (since it's in shared config)
            tail -n +2 .circleci/workflow-config.yml > workflows-only.yml
            # Concatenate shared jobs+commands with repo workflows
            cat shared-config.yml workflows-only.yml > full-config.yml

      - continuation/continue:
          configuration_path: full-config.yml
          parameters: |
            {
              "php_version": "8.3",
              "drupal_core_version": "10.4",
              "coding_standards_dirs": "${PROJECT_ROOT}/web/modules/custom ${PROJECT_ROOT}/web/modules/origins ${PROJECT_ROOT}/web/themes/custom",
              "custom_code_dirs": "${PROJECT_ROOT}/web/modules/custom ${PROJECT_ROOT}/web/modules/origins",
              "deprecated_code_dirs": "${PROJECT_ROOT}/web/modules/custom ${PROJECT_ROOT}/web/modules/origins ${PROJECT_ROOT}/web/themes/custom",
              "edge_branch": "DEPT-edge",
              "edge_build_dofdss_packages": "dof-dss/package1:dev-development dof-dss/package2:dev-development",
              "ignore_dirs": "/web/themes/origins/node_modules,/web/themes/custom/nicsdru_dept_theme/node_modules",
              "ssh_fingerprint": "65:4e:c7:ca:9f:c0:40:f7:16:2c:da:33:63:1d:90:12"
            }
