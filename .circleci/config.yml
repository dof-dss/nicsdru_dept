version: 2.1
setup: true

parameters:
  shared_config_url:
    type: string
    default: "https://raw.githubusercontent.com/johangant/ci-config/DEPT-1217--shared-config/shared-config.yml"
  php_version:
    type: string
    default: "8.3"
  drupal_core_version:
    type: string
    default: "10.4"

commands:
  generate_config:
    description: "Generate dynamic configuration"
    parameters:
      config_output_path:
        type: string
        default: "/tmp/workspace/continuation.yml"
    steps:
      - run:
          name: Fetch and customize shared config
          command: |
            curl -s << pipeline.parameters.shared_config_url >> > /tmp/shared-config.yml

            PHP_VERSION="${CIRCLE_PHP_VERSION:-<< pipeline.parameters.php_version >>}"
            DRUPAL_VERSION="${CIRCLE_DRUPAL_VERSION:-<< pipeline.parameters.drupal_core_version >>}"

            sed -i \
              -e "s/{{PHP_VERSION}}/$PHP_VERSION/g" \
              -e "s/{{DRUPAL_VERSION}}/$DRUPAL_VERSION/g" \
              /tmp/shared-config.yml

            circleci config validate /tmp/shared-config.yml
            mkdir -p $(dirname << parameters.config_output_path >>)
            cp /tmp/shared-config.yml << parameters.config_output_path >>

jobs:
  process_config:
    docker:
      - image: cimg/base:stable
    steps:
      - generate_config:
          config_output_path: "/tmp/workspace/continuation.yml"
      - run:
          name: Execute workflow
          command: |
            circleci config process /tmp/workspace/continuation.yml > processed.yml
            circleci local execute -c processed.yml --job build_test

workflows:
  setup:
    jobs:
      - process_config
