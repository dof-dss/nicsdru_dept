version: 2.1

setup: true

orbs:
  continuation: circleci/continuation@0.4.0

workflows:
  setup:
    jobs:
      - fetch-and-continue

jobs:
  fetch-and-continue:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Download shared config
          command: wget https://raw.githubusercontent.com/your-org/webdev-ci/development/shared-config.yml -O shared-config.yml

      - run:
          name: Pack local workflows config
          command: |
            circleci config pack .circleci/workflows > packed-workflows.yml

      - run:
          name: Combine shared jobs and local workflows
          command: |
            # Remove the version line from packed-workflows.yml to avoid duplicate version lines
            tail -n +2 packed-workflows.yml > workflows.yml
            # Merge shared jobs and local workflows into full config.
            cat shared-config.yml workflows.yml > full-config.yml

      - continuation/continue:
          configuration_path: full-config.yml
          parameters: |
            {
              "php_version": "8.3",
              "drupal_core_version": "10.4",
              "coding_standards_dirs": "${PROJECT_ROOT}/web/modules/custom ${PROJECT_ROOT}/web/modules/origins ${PROJECT_ROOT}/web/themes/custom",
              "deprecated_code_dirs": "${PROJECT_ROOT}/web/modules/custom ${PROJECT_ROOT}/web/modules/origins ${PROJECT_ROOT}/web/themes/custom",
              "edge_branch": "DEPT-edge",
              "edge_build_dofdss_packages": "dof-dss/package1:dev-development dof-dss/package2:dev-development",
              "ssh_fingerprint": "65:4e:c7:ca:9f:c0:40:f7:16:2c:da:33:63:1d:90:12"
            }
