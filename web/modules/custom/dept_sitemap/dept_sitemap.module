<?php

/**
 * @file
 * Primary module hooks for Departmental sites: Sitemaps module.
 */

use Drupal\dept_core\Entity\Department;
use Drupal\simple_sitemap\Entity\SimpleSitemapInterface;

/**
 * Implements hook_simple_sitemap_links_alter().
 */
function dept_sitemap_simple_sitemap_links_alter(array &$links, SimpleSitemapInterface $sitemap) {
  /** @var \Drupal\dept_core\DepartmentManager $dept_manager */
  $dept_manager = \Drupal::service('department.manager');
  $dept = $dept_manager->getDepartment($sitemap->id());

  if ($dept instanceof Department === FALSE) {
    return;
  }

  $dept_path = $dept->url();

  // Remove any links for the current sitemap variant that don't belong to this
  // variants' domain.
  foreach ($links as $key => &$link) {
    dept_sitemap_handle_domain_link($link, $dept_path);

    if (!str_contains($link['url'], $dept_path)) {
      unset($links[$key]);
    }
  }
}

/**
 * Processes a single link array from the sitemap $links
 * collection.
 */
function dept_sitemap_handle_domain_link(&$link, $dept_path) {
  $link['url'] = dept_sitemap_handle_content_url($link['url'], $dept_path);

  // Handle any translation sets.
  if (!empty($link['alternate_urls'])) {
    foreach ($link['alternate_urls'] as $langcode => $url) {
      $link['alternate_urls'][$langcode] = dept_sitemap_handle_content_url($url, $dept_path);
    }
  }
}

/**
 * Does the preprocessing of a given content URL
 * with the department hostname as context.
 *
 * @param string $url
 *   The full URL to process.
 * @param string $dept_path
 *   The hostname of the department that this applies to.
 *
 * @return string
 *   A tidied up and valid department URL.
 */
function dept_sitemap_handle_content_url(string $url, string $dept_path): string {
  // Normalise to https://.
  if (str_contains($url, 'http://')) {
    $url = str_replace('http://', 'https://', $url);
  }

  // Rewrite PSH domain pattern to full proper path.
  if (str_contains($url, '.platformsh.site') || str_contains($url, '://default/')) {
    $url_parts = parse_url($url);
    $url = $dept_path . $url_parts['path'];
  }

  return $url;
}

/**
 * Implements hook_cron().
 */
function dept_sitemap_cron() {
  // Update sitemap index urls to remove wildcard hostname patterns.
  // NB: workaround for lack of a hook or event to use when a sitemap
  // index is published or saved.
  // ANOTHER NB: Not possible ask for the site's full hostname
  // with drush as the active URL is not passed, so you end up with
  // http://default. In that case, we'll get the context of each dept
  // by loading the object using the sitemap id and asking it for its
  // URL for the current environment. From there we can use it to update
  // the XML string using a MySQL regex function where we know there might
  // be a need... eg: where the hostname is the wildcard pattern, spotted by
  // a '*' in the URL hostname.
  // TLDR: from this
  // https://finance-ni.*.uk-1.platformsh.site
  // to this
  // https://finance-ni.main-bvxea6i-dnvkwx4xjhiza.uk-1.platformsh.site
  $replace = sprintf(".%s-%s.uk-1.platformsh.site",
    getenv('PLATFORM_ENVIRONMENT') ?? '',
    getenv('PLATFORM_PROJECT') ?? '');

  // Local dev override.
  if (!empty(getenv('LANDO'))) {
    $replace = '.lndo.site';
  }

  \Drupal::database()->query("UPDATE {simple_sitemap}
    SET sitemap_string = REPLACE(sitemap_string, '.*.uk-1.platformsh.site', $replace)
    WHERE delta = :delta", [':delta' => 0])->execute();
}
