<?php

/**
 * @file
 * Departmental topics/subtopics module for controlling display
 * of topics, subtopics and related content.
 */

use Drupal\Core\Cache\Cache;
use Drupal\Core\Link;
use Drupal\dept_core\Department;
use Drupal\node\NodeInterface;

/**
 * Implements hook_theme().
 */
function dept_topics_theme($existing, $type, $theme, $path) {
  return [
    'subtopic_content_list__item' => [
      'variables' => [
        'title' => NULL,
        'title_link' => NULL,
        'content_summary' => NULL,
        'content_links' => NULL,
        'read_more_link' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function dept_topics_node_insert(NodeInterface $node) {
  if ($node->hasField('field_site_subtopics')) {
    $subtopic_ids = array_column($node->get('field_site_subtopics')
      ->getValue(), 'target_id');

    if ($node->isPublished() && !empty($subtopic_ids)) {
      $subtopic_cache_tags = preg_filter('/^/', 'subtopic_stack:', $subtopic_ids);
      // Published nodes with subtopic values should expire the cache
      // tags for subtopic content stack render elements.
      Cache::invalidateTags($subtopic_cache_tags);
    }
  }
}
